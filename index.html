<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADIFINCAS | Gesti√≥n v3.4</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0056b3; 
            --primary-dark: #003d82;
            --bg: #f3f4f6; 
            --white: #ffffff; 
            --text: #1f2937;
            --border: #e5e7eb; 
            --danger: #dc2626;
            --warning-bg: #fffbeb; 
            --warning-border: #fcd34d;
            --success: #059669;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: none; }

        /* LOGIN (Estilo Index.2) */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, #002a4d 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .btn-login { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-login:hover { background: var(--primary-dark); }
        .error-msg { color: var(--danger); font-size: 0.85rem; margin-top: 10px; display: none; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: var(--white); padding: 15px 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .logo h1 { margin: 0; font-size: 1.5rem; color: var(--primary); letter-spacing: -0.5px; }
        .user-badge { background: #eff6ff; color: var(--primary); padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; border: 1px solid #dbeafe; }
        .btn-db { background: var(--success); color: white; padding: 8px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; margin-left: 10px; text-decoration: none; display: inline-block;}
        .btn-db:hover { background: #047857; }

        /* LAYOUT */
        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 25px; align-items: start; }
        .form-section { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: sticky; top: 20px; }
        .data-section { background: var(--white); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }

        /* FORMULARIOS */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #4b5563; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-family: inherit; font-size: 0.95rem; transition: border-color 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1); }
        button.btn-primary { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button.btn-primary:hover { background: var(--primary-dark); }

        /* ZONA DE FILTROS (Dise√±o integrado) */
        .filters-bar { padding: 20px; background: #ffffff; border-bottom: 1px solid var(--border); display: flex; gap: 15px; flex-wrap: wrap; }
        .filter-input { flex: 1; min-width: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: #f9fafb; }
        .filter-select { width: 180px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: #f9fafb; cursor: pointer; }

        /* TABLA (Estilo limpio Index.2) */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 20px; background: #f9fafb; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 700; border-bottom: 1px solid var(--border); }
        td { padding: 15px 20px; border-bottom: 1px solid var(--border); font-size: 0.9rem; vertical-align: top; color: #374151; }
        tr:hover { background-color: #f8fafc; }
        
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; display: inline-block; }
        .tag-pendiente { background: #fee2e2; color: #991b1b; }
        .tag-en-curso { background: #fef3c7; color: #92400e; }
        .tag-resuelto { background: #d1fae5; color: #065f46; }

        /* Bot√≥n de Acci√≥n en Tabla */
        .btn-action { background: #eff6ff; color: var(--primary); border: 1px solid #bfdbfe; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-action:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* MODAL UNIFICADO */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal h2 { margin-top: 0; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }

        .history-box { background: #f8fafc; padding: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; color: #334155; max-height: 250px; overflow-y: auto; white-space: pre-wrap; margin-bottom: 20px; line-height: 1.5; }

        /* ZONA DE EDICI√ìN */
        #editSection { display: none; border-top: 1px solid var(--border); padding-top: 20px; margin-top: 10px; animation: slideDown 0.3s; }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }

        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-close { background: #e5e7eb; padding: 10px 20px; border-radius: 6px; cursor: pointer; border: none; color: #374151; font-weight: bold; }
        .btn-close:hover { background: #d1d5db; }
        .btn-add { background: var(--primary); color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
        .btn-add:hover { background: var(--primary-dark); }
        .btn-save { background: var(--success); color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; width: 100%; }
        .btn-save:hover { background: #047857; }

        /* ALERTAS */
        #matchAlert { display: none; background: #fff7ed; border: 1px solid #fdba74; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .mini-history-item { background: white; border: 1px solid #fed7aa; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }

        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } .filters-bar { flex-direction: column; } .filter-select { width: 100%; } }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h1 style="color:var(--primary); margin:0 0 10px;">ADIFINCAS</h1>
        <p style="color:#6b7280; margin-bottom:30px;">Intranet Segura</p>
        <form id="loginForm">
            <input type="email" id="loginEmail" class="login-input" placeholder="usuario@adifincas.es" required>
            <input type="password" id="loginPass" class="login-input" placeholder="Contrase√±a" required>
            <button type="submit" class="btn-login">Entrar al Sistema</button>
            <div id="loginError" class="error-msg">Credenciales incorrectas</div>
        </form>
    </div>
</div>

<div class="container" id="appContainer">
    <header>
        <div class="logo">
            <h1>ADIFINCAS <span style="font-size:0.5em; color:#9ca3af; font-weight:400">| Gesti√≥n v3.4</span></h1>
        </div>
        <div class="user-info">
            <span class="user-badge" id="displayUser">Invitado</span>
            <button class="btn-db" onclick="scrollToTable()">üóÑÔ∏è Ver Listado</button>
            <button class="btn-db" onclick="exportToExcel()" style="background:#15803d;">üì• Excel</button>
        </div>
    </header>

    <div class="main-grid">
        <section class="form-section">
            <h2 style="margin-top:0; color:var(--primary); font-size:1.2rem; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:20px;">üìû Registrar Llamada</h2>
            <form id="callForm">
                <div class="form-group">
                    <label>Cliente / Raz√≥n Social</label>
                    <input type="text" id="callerName" placeholder="Buscar nombre..." autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="text" id="phoneNumber" placeholder="Ej: 600..." autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label>Comunidad</label>
                    <input type="text" id="community" placeholder="Ej: C/ Mayor 1" autocomplete="off" required>
                </div>

                <div id="matchAlert">
                    <h4 style="margin:0 0 10px; color:#c2410c; font-size:0.9rem;">‚ö†Ô∏è Historial Detectado:</h4>
                    <div id="matchList"></div>
                </div>

                <div class="form-group">
                    <label>Estado Inicial</label>
                    <select id="status">
                        <option value="Pendiente">üî¥ Pendiente</option>
                        <option value="En Curso">üü† En Curso</option>
                        <option value="Resuelto">üü¢ Resuelto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Motivo de la Llamada</label>
                    <textarea id="reason" placeholder="Describe el problema..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Acci√≥n Realizada / Nota</label>
                    <textarea id="action" placeholder="Nota inicial..." style="min-height: 60px;"></textarea>
                </div>
                <button type="submit" class="btn-primary" id="submitBtn">Guardar Registro</button>
            </form>
        </section>

        <section class="data-section" id="databaseSection">
            <div class="filters-bar">
                <input type="text" id="mainSearch" class="filter-input" placeholder="üîç Buscar por Nombre, Tel√©fono, Comunidad...">
                <select id="filterStatus" class="filter-select" onchange="applyFilters()">
                    <option value="">Todo Estado</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="En Curso">En Curso</option>
                    <option value="Resuelto">Resuelto</option>
                </select>
            </div>

            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Comunidad</th>
                            <th>Estado</th>
                            <th style="text-align:center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="5" style="text-align:center; padding:30px; color:#64748b;">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>
</div>

<div class="modal-overlay" id="detailModal">
    <div class="modal">
        <h2>Detalle del Registro</h2>
        <input type="hidden" id="modalId">
        <input type="hidden" id="modalOldAction">

        <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:15px; display:flex; justify-content:space-between;">
            <div>
                <small style="color:#64748b; font-weight:bold;">CLIENTE</small><br>
                <span id="modalClientInfo">...</span>
            </div>
            <div style="text-align:right;">
                <small style="color:#64748b; font-weight:bold;">ESTADO</small><br>
                <strong id="modalStatusDisplay" style="color:var(--primary);">...</strong>
            </div>
        </div>
        <div style="margin-bottom:15px;">
            <small style="color:#64748b; font-weight:bold;">COMUNIDAD</small><br>
            <span id="modalCommunityDisplay">...</span>
        </div>

        <label>Historial de Notas y Acciones</label>
        <div id="modalHistory" class="history-box"></div>

        <div class="modal-buttons" id="viewButtons">
            <button class="btn-close" onclick="closeModal()">Cerrar</button>
            <button class="btn-add" onclick="showEditSection()">‚ûï A√±adir Nota</button>
        </div>

        <div id="editSection">
            <label>Nueva Nota (Se a√±adir√° con fecha y hora)</label>
            <textarea id="modalNewNote" rows="3" placeholder="Escribe aqu√≠..."></textarea>
            
            <label style="margin-top:10px;">Actualizar Estado</label>
            <select id="modalEditStatus">
                <option value="Pendiente">Pendiente</option>
                <option value="En Curso">En Curso</option>
                <option value="Resuelto">Resuelto</option>
            </select>

            <div style="margin-top:15px;">
                <button class="btn-save" onclick="saveAndClose()">Guardar Nota y Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // 1. LOGIN
    const USERS = {
        "inavarro@adifincas.es": { pass: "inavarro", name: "Navarro" },
        "atencion1@adifincas.es": { pass: "atencion1", name: "Atencion1" },
        "jmgallego@adifincas.es": { pass: "jmgallego", name: "Jmgallego" }
    };
    let CURRENT_USER_NAME = "Invitado";

    document.getElementById("loginForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value.toLowerCase().trim();
        const pass = document.getElementById("loginPass").value.trim();
        if (USERS[email] && USERS[email].pass === pass) {
            CURRENT_USER_NAME = USERS[email].name;
            document.getElementById("displayUser").innerText = CURRENT_USER_NAME;
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("appContainer").style.display = "block";
            initFirebase();
        } else {
            document.getElementById("loginError").style.display = "block";
        }
    });

    // 2. FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBqgvaRhWg7rm5FeKchH08H5zQr5d6fXDY",
        authDomain: "adifincas-db.firebaseapp.com",
        databaseURL: "https://adifincas-db-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "adifincas-db",
        storageBucket: "adifincas-db.firebasestorage.app",
        messagingSenderId: "987315627646",
        appId: "1:987315627646:web:66049a3005281035e7da2f",
        measurementId: "G-G1Y3L2LS3D"
    };

    let db, callsRef, allCalls = [];

    function initFirebase() {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        callsRef = ref(db, 'registros_adifincas');
        onValue(callsRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) { allCalls = []; renderTable([]); return; }
            allCalls = Object.entries(data).map(([id, val]) => ({ id, ...val })).reverse();
            applyFilters();
            checkMatches();
        });
    }

    // 3. TABLA Y FILTROS
    window.scrollToTable = () => document.getElementById("databaseSection").scrollIntoView({behavior: "smooth"});
    
    window.applyFilters = function() {
        const term = document.getElementById("mainSearch").value.toLowerCase();
        const statusFilter = document.getElementById("filterStatus").value;

        const filtered = allCalls.filter(c => {
            const textMatch = JSON.stringify(c).toLowerCase().includes(term);
            const statusMatch = statusFilter === "" || c.status === statusFilter;
            return textMatch && statusMatch;
        });
        
        renderTable(filtered);
    };

    function renderTable(data) {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        data.forEach(call => {
            const tr = document.createElement("tr");
            const cleanStatus = call.status ? call.status.toLowerCase().replace(" ", "-") : "pendiente";
            const comm = call.community || "-";
            tr.innerHTML = `
                <td style="color:#64748b; font-size:0.85em">${call.date}<br>${call.time}</td>
                <td><strong>${call.name}</strong><br><small style="color:#64748b">${call.phone}</small></td>
                <td>${comm}</td>
                <td><span class="tag tag-${cleanStatus}">${call.status}</span></td>
                <td style="text-align:center;">
                    <button class="btn-action" onclick='openDetailFromTable("${call.id}")'>üëÅÔ∏è Ver / Editar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 4. DETECTOR DE COINCIDENCIAS
    const nameInput = document.getElementById("callerName");
    const phoneInput = document.getElementById("phoneNumber");

    function checkMatches() {
        const nameVal = nameInput.value.toLowerCase();
        const phoneVal = phoneInput.value.replace(/\s/g, '');
        if (nameVal.length < 3 && phoneVal.length < 4) {
            document.getElementById("matchAlert").style.display = "none";
            return;
        }
        const matches = allCalls.filter(call => {
            const cName = call.name.toLowerCase();
            const cPhone = call.phone.replace(/\s/g, '');
            return (nameVal.length >= 3 && cName.includes(nameVal)) || 
                   (phoneVal.length >= 4 && cPhone.includes(phoneVal));
        });
        renderMatches(matches);
    }

    function renderMatches(matches) {
        const alertBox = document.getElementById("matchAlert");
        const list = document.getElementById("matchList");
        if (matches.length === 0) { alertBox.style.display = "none"; return; }
        
        alertBox.style.display = "block";
        list.innerHTML = "";
        
        matches.slice(0, 3).forEach(m => {
            const item = document.createElement("div");
            item.className = "mini-history-item";
            item.innerHTML = `
                <div>
                    <strong>${m.date}</strong> - ${m.status}<br>
                    <span style="font-size:0.8em; color:#666">${m.community || 'Sin comunidad'}</span>
                </div>
                <button class="btn-action" style="font-size:0.7rem; padding:4px 8px;">üëÅÔ∏è Ver</button>
            `;
            item.querySelector("button").addEventListener("click", (e) => { 
                e.preventDefault(); 
                openDetailModal(m); 
            });
            list.appendChild(item);
        });
    }

    // 5. MODAL UNIFICADO
    window.openDetailFromTable = function(id) {
        const call = allCalls.find(c => c.id === id);
        if(call) openDetailModal(call);
    }

    window.openDetailModal = function(call) {
        document.getElementById("modalId").value = call.id;
        document.getElementById("modalOldAction").value = call.action || "";
        
        document.getElementById("modalStatusDisplay").innerText = call.status;
        document.getElementById("modalCommunityDisplay").innerText = call.community || "N/A";
        document.getElementById("modalClientInfo").innerText = `${call.name} (${call.phone})`;
        
        const historyText = `[MOTIVO]: ${call.reason}\n\n[HISTORIAL]:\n${call.action || "Sin notas previas."}`;
        document.getElementById("modalHistory").innerText = historyText;

        // Reset vista
        document.getElementById("editSection").style.display = "none";
        document.getElementById("viewButtons").style.display = "flex";
        document.getElementById("detailModal").style.display = "flex";
    };

    window.showEditSection = function() {
        document.getElementById("viewButtons").style.display = "none";
        document.getElementById("editSection").style.display = "block";
        
        const currentStatus = document.getElementById("modalStatusDisplay").innerText;
        document.getElementById("modalEditStatus").value = currentStatus;
        document.getElementById("modalNewNote").focus();
    };

    window.saveAndClose = function() {
        const id = document.getElementById("modalId").value;
        const newNote = document.getElementById("modalNewNote").value.trim();
        const newStatus = document.getElementById("modalEditStatus").value;
        const oldAction = document.getElementById("modalOldAction").value;

        if (!newNote) { alert("La nota no puede estar vac√≠a."); return; }

        const now = new Date();
        const timeStamp = `[${now.toLocaleDateString()} ${now.toLocaleTimeString().slice(0,5)}] ${CURRENT_USER_NAME}:`;
        const finalAction = `${timeStamp} ${newNote}\n\n${oldAction}`; 

        update(ref(db, 'registros_adifincas/' + id), {
            status: newStatus,
            action: finalAction
        }).then(() => {
            closeModal();
        });
    };

    window.closeModal = function() {
        document.getElementById("detailModal").style.display = "none";
        document.getElementById("modalNewNote").value = "";
    };

    // 6. GUARDAR NUEVO
    document.getElementById("callForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const btn = document.getElementById("submitBtn");
        btn.disabled = true; btn.innerText = "Guardando...";
        
        const now = new Date();
        push(callsRef, {
            user: CURRENT_USER_NAME,
            name: document.getElementById("callerName").value,
            phone: document.getElementById("phoneNumber").value,
            community: document.getElementById("community").value,
            status: document.getElementById("status").value,
            reason: document.getElementById("reason").value,
            action: document.getElementById("action").value,
            date: now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
            time: now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
        }).then(() => {
            document.getElementById("callForm").reset();
            document.getElementById("matchAlert").style.display = "none";
            btn.disabled = false; btn.innerText = "Guardar Registro";
        });
    });

    // 7. EXCEL
    window.exportToExcel = () => {
        let csv = "Fecha,Hora,Agente,Cliente,Comunidad,Telefono,Estado,Motivo,Accion\n";
        allCalls.forEach(c => {
            csv += `"${c.date}","${c.time}","${c.user}","${c.name}","${c.community||''}","${c.phone}","${c.status}","${c.reason.replace(/"/g, '""')}","${(c.action||'').replace(/"/g, '""')}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Base_Datos_Adifincas.csv";
        link.click();
    };

    // Listeners
    nameInput.addEventListener("input", checkMatches);
    phoneInput.addEventListener("input", checkMatches);
    document.getElementById("mainSearch").addEventListener("keyup", applyFilters);

</script>
</body>
</html>
