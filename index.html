<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADIFINCAS | Gesti√≥n Incidencias</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand: #0f172a;       /* Azul Muy Oscuro (Serio) */
            --accent: #3b82f6;      /* Azul Acci√≥n */
            --bg-body: #f1f5f9;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; height: 100vh; overflow: hidden; display: flex; }

        /* LOGIN */
        #loginScreen { position: fixed; inset: 0; background: var(--brand); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; }
        .btn-full { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* LAYOUT */
        .sidebar { width: 240px; background: var(--brand); color: white; display: flex; flex-direction: column; padding: 20px; }
        .logo { font-size: 1.4rem; font-weight: 700; margin-bottom: 40px; letter-spacing: 1px; color: white; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: #94a3b8; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        
        .main { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .title { font-size: 1.8rem; font-weight: 700; color: var(--brand); }

        /* VISTAS */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        /* TABLAS */
        .crm-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .crm-table th { text-align: left; padding: 10px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; }
        .crm-row { background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .crm-row:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .crm-row td { padding: 15px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        .crm-row td:first-child { border-left: 1px solid var(--border); border-radius: 8px 0 0 8px; font-weight: bold; color: var(--accent); }
        .crm-row td:last-child { border-right: 1px solid var(--border); border-radius: 0 8px 8px 0; }

        /* TAGS */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .st-nuevo { background: #dbeafe; color: #1e40af; }
        .st-curso { background: #fef3c7; color: #92400e; }
        .st-resuelto { background: #dcfce7; color: #166534; }

        /* MODALES */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-window { background: white; width: 90%; max-width: 900px; height: 85vh; border-radius: 12px; display: flex; overflow: hidden; }
        
        /* DETALLE TICKET */
        .ticket-layout { display: grid; grid-template-columns: 280px 1fr; width: 100%; height: 100%; }
        .ticket-info { background: #f8fafc; border-right: 1px solid var(--border); padding: 25px; overflow-y: auto; }
        .ticket-chat { display: flex; flex-direction: column; height: 100%; background: white; }
        .chat-feed { flex: 1; padding: 25px; overflow-y: auto; }
        .chat-input { padding: 20px; border-top: 1px solid var(--border); background: #f8fafc; }

        /* Timeline Items */
        .msg-item { margin-bottom: 15px; }
        .msg-meta { font-size: 0.75rem; color: #64748b; margin-bottom: 4px; }
        .msg-bubble { background: white; border: 1px solid var(--border); padding: 10px 15px; border-radius: 8px; font-size: 0.9rem; display: inline-block; max-width: 90%; }
        .msg-system { text-align: center; color: #94a3b8; font-style: italic; font-size: 0.8rem; margin: 15px 0; }

        /* FORMULARIOS */
        label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 5px; color: #64748b; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; margin-bottom: 15px; }
        .btn-action { padding: 8px 15px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }

    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-card">
        <h2 style="margin-top:0; color:var(--brand);">ADIFINCAS</h2>
        <p>Gesti√≥n de Incidencias</p>
        <form id="loginForm">
            <input type="email" id="loginEmail" class="login-input" placeholder="usuario@adifincas.es" required>
            <input type="password" id="loginPass" class="login-input" placeholder="Contrase√±a" required>
            <button type="submit" class="btn-full">Entrar</button>
            <p id="loginError" style="color:var(--danger); display:none; margin-top:10px;">Error de acceso</p>
        </form>
    </div>
</div>

<div class="sidebar">
    <div class="logo">ADIFINCAS</div>
    <div class="nav-item active" onclick="nav('dashboard')">üìä Dashboard</div>
    <div class="nav-item" onclick="nav('tickets')">üé´ Tickets</div>
    <div class="nav-item" onclick="nav('communities')">üè¢ Comunidades</div>
    
    <div style="margin-top:auto; font-size:0.8rem; opacity:0.7;">
        Usuario: <span id="displayUser">...</span>
    </div>
</div>

<div class="main">
    
    <div id="view-dashboard" class="view active">
        <div class="header">
            <div class="title">Resumen</div>
            <button class="btn-primary" onclick="openNewTicket()">+ Nueva Incidencia</button>
        </div>
        
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:30px;">
            <div style="background:white; padding:20px; border-radius:8px; border-left:4px solid var(--accent);">
                <div style="color:#64748b;">Abiertos</div>
                <div style="font-size:2rem; font-weight:bold;" id="kpiOpen">0</div>
            </div>
            <div style="background:white; padding:20px; border-radius:8px; border-left:4px solid var(--warning);">
                <div style="color:#64748b;">En Curso</div>
                <div style="font-size:2rem; font-weight:bold;" id="kpiPending">0</div>
            </div>
            <div style="background:white; padding:20px; border-radius:8px; border-left:4px solid var(--success);">
                <div style="color:#64748b;">Resueltos</div>
                <div style="font-size:2rem; font-weight:bold;" id="kpiSolved">0</div>
            </div>
        </div>

        <h3>√öltimas Incidencias</h3>
        <table class="crm-table">
            <thead><tr><th>ID</th><th>Asunto</th><th>Comunidad</th><th>Estado</th><th>Agente</th></tr></thead>
            <tbody id="dashTable"></tbody>
        </table>
    </div>

    <div id="view-tickets" class="view">
        <div class="header">
            <div class="title">Listado de Incidencias</div>
            <input type="text" id="searchTicket" placeholder="üîç Buscar por comunidad, persona..." style="width:300px; margin:0;">
        </div>
        <table class="crm-table">
            <thead><tr><th>ID</th><th>Fecha</th><th>Asunto</th><th>Comunidad</th><th>Solicitante</th><th>Estado</th></tr></thead>
            <tbody id="ticketsTable"></tbody>
        </table>
    </div>

    <div id="view-communities" class="view">
        <div class="header">
            <div class="title">Base de Datos Comunidades</div>
        </div>
        <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
            <h3>üì§ Importar desde Excel (CSV)</h3>
            <p style="color:#64748b; font-size:0.9rem;">Sube un archivo .csv con los nombres de las comunidades (una por l√≠nea) para actualizar el listado.</p>
            <input type="file" id="csvFile" accept=".csv" style="border:1px dashed #cbd5e1; padding:20px; width:100%;">
            <button class="btn-primary" onclick="processCSV()">Cargar Comunidades</button>
            <div id="uploadStatus" style="margin-top:10px; font-weight:bold; color:var(--success);"></div>
        </div>
        
        <h3>Listado Actual (<span id="commCount">0</span>)</h3>
        <div id="commList" style="background:white; padding:20px; border-radius:8px; max-height:400px; overflow-y:auto; column-count:2;">
            </div>
    </div>

</div>

<div class="modal-overlay" id="newTicketModal">
    <div class="modal-window" style="height:auto; max-width:500px; padding:30px; display:block;">
        <h2 style="margin-top:0;">Nueva Incidencia</h2>
        <form id="newTicketForm">
            <label>Asunto / Resumen</label>
            <input type="text" id="ntSubject" placeholder="Ej: Puerta garaje averiada" required>

            <label>Comunidad</label>
            <input type="text" id="ntCommunity" list="commDatalist" placeholder="Escribe para buscar..." required>
            <datalist id="commDatalist"></datalist>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label>Solicitante</label>
                    <input type="text" id="ntCaller" placeholder="Nombre persona" required>
                </div>
                <div>
                    <label>Tel√©fono</label>
                    <input type="text" id="ntPhone" placeholder="600...">
                </div>
            </div>

            <label>Descripci√≥n</label>
            <textarea id="ntDesc" rows="3" required></textarea>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button type="button" class="btn-action" onclick="closeModals()">Cancelar</button>
                <button type="submit" class="btn-primary">Crear Incidencia</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="detailModal">
    <div class="modal-window">
        <div class="ticket-layout">
            <div class="ticket-info">
                <h3 id="dtId" style="color:#64748b; margin-top:0;">#TK-000</h3>
                <h2 id="dtSubject" style="margin-top:5px; font-size:1.2rem;">Asunto</h2>
                
                <hr style="border:0; border-top:1px solid #e2e8f0; margin:20px 0;">
                
                <label>Estado</label>
                <select id="dtStatus" onchange="updateStatus()">
                    <option value="Nuevo">Nuevo</option>
                    <option value="En Curso">En Curso</option>
                    <option value="Resuelto">Resuelto</option>
                </select>

                <label>Comunidad</label>
                <div id="dtComm" style="font-weight:bold; margin-bottom:15px;">...</div>

                <label>Contacto</label>
                <div style="background:white; border:1px solid #e2e8f0; padding:10px; border-radius:6px;">
                    <div id="dtCaller">Nombre</div>
                    <div id="dtPhone" style="color:var(--accent); font-size:0.9rem;">Tel</div>
                </div>
                
                <div style="margin-top:30px;">
                    <button class="btn-action" style="width:100%; color:var(--danger); border-color:var(--danger);" onclick="deleteTicket()">üóë Eliminar</button>
                    <button class="btn-action" style="width:100%; margin-top:10px;" onclick="closeModals()">Cerrar</button>
                </div>
            </div>
            
            <div class="ticket-chat">
                <div class="chat-feed" id="timelineFeed"></div>
                <div class="chat-input">
                    <textarea id="chatInput" rows="2" placeholder="Escribe una nota de seguimiento..."></textarea>
                    <div style="text-align:right; margin-top:10px;">
                        <button class="btn-primary" onclick="addNote()">A√±adir Nota</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // --- CONFIGURACI√ìN FIREBASE (PEGAR CLAVES) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBqgvaRhWg7rm5FeKchH08H5zQr5d6fXDY",
        authDomain: "adifincas-db.firebaseapp.com",
        databaseURL: "https://adifincas-db-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "adifincas-db",
        storageBucket: "adifincas-db.firebasestorage.app",
        messagingSenderId: "987315627646",
        appId: "1:987315627646:web:66049a3005281035e7da2f",
        measurementId: "G-G1Y3L2LS3D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ESTADO
    let currentUser = null;
    let currentTicketId = null;
    let allTickets = [];
    let allCommunities = [];

    const USERS = {
        "inavarro@adifincas.es": {p:"inavarro", n:"Navarro"},
        "atencion1@adifincas.es": {p:"atencion1", n:"Atenci√≥n1"},
        "jmgallego@adifincas.es": {p:"jmgallego", n:"JMGallego"}
    };

    // LOGIN
    document.getElementById("loginForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const mail = document.getElementById("loginEmail").value.trim().toLowerCase();
        const pass = document.getElementById("loginPass").value.trim();
        if(USERS[mail] && USERS[mail].p === pass){
            currentUser = USERS[mail].n;
            document.getElementById("displayUser").innerText = currentUser;
            document.getElementById("loginScreen").style.display="none";
            document.querySelector(".main").style.display="block";
            initApp();
        } else {
            document.getElementById("loginError").style.display="block";
        }
    });

    function initApp() {
        // Cargar Tickets
        onValue(ref(db, 'crm_tickets'), (snap) => {
            const data = snap.val();
            allTickets = data ? Object.entries(data).map(([k,v])=>({id:k, ...v})).reverse() : [];
            renderDash();
            renderTickets();
        });

        // Cargar Comunidades
        onValue(ref(db, 'crm_communities'), (snap) => {
            const data = snap.val();
            allCommunities = data ? Object.values(data) : [];
            renderCommunities();
        });
    }

    // RENDERIZADO
    function renderDash() {
        document.getElementById("kpiOpen").innerText = allTickets.filter(t=>t.status==='Nuevo').length;
        document.getElementById("kpiPending").innerText = allTickets.filter(t=>t.status==='En Curso').length;
        document.getElementById("kpiSolved").innerText = allTickets.filter(t=>t.status==='Resuelto').length;

        const tbody = document.getElementById("dashTable");
        tbody.innerHTML = "";
        allTickets.slice(0, 5).forEach(t => {
            tbody.innerHTML += `
            <tr class="crm-row" onclick="window.openDetail('${t.id}')">
                <td>${t.ticketNum}</td>
                <td>${t.subject}</td>
                <td>${t.community}</td>
                <td><span class="badge st-${t.status==='Nuevo'?'nuevo':(t.status==='En Curso'?'curso':'resuelto')}">${t.status}</span></td>
                <td>${t.agent}</td>
            </tr>`;
        });
    }

    function renderTickets() {
        const tbody = document.getElementById("ticketsTable");
        tbody.innerHTML = "";
        allTickets.forEach(t => {
            tbody.innerHTML += `
            <tr class="crm-row" onclick="window.openDetail('${t.id}')">
                <td style="font-weight:bold; color:var(--accent)">${t.ticketNum}</td>
                <td>${t.date}</td>
                <td>${t.subject}</td>
                <td>${t.community}</td>
                <td>${t.caller}</td>
                <td><span class="badge st-${t.status==='Nuevo'?'nuevo':(t.status==='En Curso'?'curso':'resuelto')}">${t.status}</span></td>
            </tr>`;
        });
    }

    function renderCommunities() {
        // Llenar Datalist del formulario
        const dl = document.getElementById("commDatalist");
        dl.innerHTML = "";
        allCommunities.sort().forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            dl.appendChild(opt);
        });

        // Llenar lista visual
        document.getElementById("commCount").innerText = allCommunities.length;
        document.getElementById("commList").innerHTML = allCommunities.map(c => `<div style="padding:5px; border-bottom:1px solid #eee;">üè¢ ${c}</div>`).join('');
    }

    // CARGA MASIVA DE CSV
    window.processCSV = function() {
        const file = document.getElementById("csvFile").files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            // Separar por lineas y limpiar
            const lines = text.split(/\r\n|\n/).map(line => line.trim()).filter(line => line.length > 0);
            
            // Subir a Firebase (sobrescribe o a√±ade seg√∫n l√≥gica, aqu√≠ vamos a reemplazar lista completa para evitar duplicados complejos o podr√≠amos a√±adir)
            // Para simplicidad: A√±adimos una entrada por cada comunidad usando el nombre como clave (limpiando caracteres raros)
            const updates = {};
            lines.forEach(comm => {
                const key = comm.replace(/[.#$/\[\]]/g, ""); // Firebase no permite estos caracteres en claves
                updates[key] = comm;
            });

            update(ref(db, 'crm_communities'), updates).then(() => {
                document.getElementById("uploadStatus").innerText = `‚úÖ ${lines.length} comunidades cargadas con √©xito.`;
            });
        };
        reader.readAsText(file);
    };

    // CREAR TICKET
    window.openNewTicket = () => document.getElementById("newTicketModal").style.display = "flex";
    window.closeModals = () => document.querySelectorAll(".modal-overlay").forEach(e=>e.style.display="none");

    document.getElementById("newTicketForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const now = new Date();
        const newRef = push(ref(db, 'crm_tickets'));
        const tkData = {
            ticketNum: "INC-" + Math.floor(10000 + Math.random() * 90000),
            subject: document.getElementById("ntSubject").value,
            community: document.getElementById("ntCommunity").value,
            caller: document.getElementById("ntCaller").value,
            phone: document.getElementById("ntPhone").value,
            desc: document.getElementById("ntDesc").value,
            status: "Nuevo",
            agent: currentUser,
            date: now.toLocaleDateString('es-ES'),
            ts: Date.now()
        };
        
        set(newRef, tkData);
        // Primer mensaje en timeline
        push(ref(db, `crm_tickets/${newRef.key}/timeline`), {
            text: "Incidencia creada: " + tkData.desc,
            author: "Sistema",
            type: "system",
            ts: Date.now()
        });

        document.getElementById("newTicketForm").reset();
        window.closeModals();
    });

    // DETALLE
    window.openDetail = function(id) {
        currentTicketId = id;
        const t = allTickets.find(x => x.id === id);
        
        document.getElementById("dtId").innerText = t.ticketNum;
        document.getElementById("dtSubject").innerText = t.subject;
        document.getElementById("dtStatus").value = t.status;
        document.getElementById("dtComm").innerText = "üè¢ " + t.community;
        document.getElementById("dtCaller").innerText = t.caller;
        document.getElementById("dtPhone").innerText = t.phone || "Sin tel√©fono";

        // Cargar chat
        onValue(ref(db, `crm_tickets/${id}/timeline`), (snap) => {
            const feed = document.getElementById("timelineFeed");
            feed.innerHTML = "";
            const msgs = snap.val() ? Object.values(snap.val()).sort((a,b)=>a.ts - b.ts) : [];
            
            msgs.forEach(m => {
                if(m.type === 'system') {
                    feed.innerHTML += `<div class="msg-system">${m.text} - ${new Date(m.ts).toLocaleString()}</div>`;
                } else {
                    feed.innerHTML += `
                    <div class="msg-item">
                        <div class="msg-meta"><strong>${m.author}</strong> ‚Ä¢ ${new Date(m.ts).toLocaleString()}</div>
                        <div class="msg-bubble">${m.text}</div>
                    </div>`;
                }
            });
            feed.scrollTop = feed.scrollHeight;
        });

        document.getElementById("detailModal").style.display = "flex";
    };

    window.addNote = function() {
        const txt = document.getElementById("chatInput").value;
        if(!txt) return;
        push(ref(db, `crm_tickets/${currentTicketId}/timeline`), {
            text: txt,
            author: currentUser,
            type: "user",
            ts: Date.now()
        });
        document.getElementById("chatInput").value = "";
    };

    window.updateStatus = function() {
        update(ref(db, `crm_tickets/${currentTicketId}`), {
            status: document.getElementById("dtStatus").value
        });
    };
    
    window.deleteTicket = function() {
        if(confirm("¬øBorrar incidencia definitivamente?")) {
            remove(ref(db, `crm_tickets/${currentTicketId}`));
            window.closeModals();
        }
    };

    // NAVEGACI√ìN
    window.nav = function(view) {
        document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
        document.getElementById("view-"+view).classList.add("active");
        document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
        event.currentTarget.classList.add("active");
    };

    // BUSCADOR
    document.getElementById("searchTicket").addEventListener("keyup", (e)=>{
        const term = e.target.value.toLowerCase();
        const filtered = allTickets.filter(t => JSON.stringify(t).toLowerCase().includes(term));
        // Re-render simplificado (copia de la funci√≥n renderTickets)
        const tbody = document.getElementById("ticketsTable");
        tbody.innerHTML = "";
        filtered.forEach(t => {
            tbody.innerHTML += `
            <tr class="crm-row" onclick="window.openDetail('${t.id}')">
                <td style="font-weight:bold; color:var(--accent)">${t.ticketNum}</td>
                <td>${t.date}</td>
                <td>${t.subject}</td>
                <td>${t.community}</td>
                <td>${t.caller}</td>
                <td><span class="badge st-${t.status==='Nuevo'?'nuevo':(t.status==='En Curso'?'curso':'resuelto')}">${t.status}</span></td>
            </tr>`;
        });
    });

</script>
</body>
</html>
