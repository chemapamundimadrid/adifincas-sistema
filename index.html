<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADIFINCAS | Intranet Segura</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0056b3;
            --primary-dark: #003d82;
            --bg: #f3f4f6;
            --white: #ffffff;
            --text: #1f2937;
            --border: #e5e7eb;
            --danger: #dc2626;
            --warning-bg: #fffbeb;
            --warning-border: #fcd34d;
            --success: #059669;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: none; /* Oculto hasta login */ }

        /* --- PANTALLA DE LOGIN --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, #002a4d 100%);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            width: 100%; max-width: 350px; text-align: center;
        }
        .login-logo h1 { color: var(--primary); margin: 0 0 10px 0; font-size: 1.8rem; }
        .login-logo p { color: #6b7280; margin: 0 0 30px 0; font-size: 0.9rem; }
        .login-input {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border);
            border-radius: 8px; font-size: 1rem; box-sizing: border-box;
        }
        .btn-login {
            width: 100%; background: var(--primary); color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.2s;
        }
        .btn-login:hover { background: var(--primary-dark); }
        .error-msg { color: var(--danger); font-size: 0.85rem; margin-top: 10px; display: none; }

        /* --- CABECERA APP --- */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: var(--white); padding: 15px 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .logo h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-badge { background: #eff6ff; color: var(--primary); padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; border: 1px solid #dbeafe; }
        
        /* BOT√ìN BASE DE DATOS */
        .btn-db {
            display: flex; align-items: center; gap: 8px; background: var(--success); color: white; 
            padding: 8px 15px; border-radius: 8px; text-decoration: none; font-weight: 600; 
            font-size: 0.9rem; cursor: pointer; border: none; transition: 0.2s;
        }
        .btn-db:hover { background: #047857; transform: translateY(-1px); }

        /* LAYOUT PRINCIPAL */
        .main-grid { display: grid; grid-template-columns: 380px 1fr; gap: 25px; align-items: start; }

        /* FORMULARIO */
        .form-section { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: sticky; top: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #4b5563; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        input:focus, textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }
        button.btn-primary { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; }

        /* ALERTAS DE COINCIDENCIAS */
        #matchAlert { display: none; background: var(--warning-bg); border: 1px solid var(--warning-border); padding: 15px; border-radius: 8px; margin-top: 20px; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
        
        #matchAlert h4 { margin: 0 0 10px 0; color: #92400e; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .mini-history-item { background: white; border: 1px solid #fed7aa; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.85rem; }
        .mini-history-header { display: flex; justify-content: space-between; font-weight: bold; color: #555; margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .btn-mini-edit { background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 0; margin-left: 5px; }

        /* TABLA GENERAL */
        .data-section { background: var(--white); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        .search-bar { padding: 15px; background: #f9fafb; border-bottom: 1px solid var(--border); display: flex; gap: 10px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 20px; background: #f9fafb; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; border-bottom: 1px solid var(--border); }
        td { padding: 14px 20px; border-bottom: 1px solid var(--border); font-size: 0.9rem; vertical-align: top; }
        tr:hover { background: #f8fafc; }

        .tag { padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .tag-pendiente { background: #fee2e2; color: #991b1b; }
        .tag-en-curso { background: #fef3c7; color: #92400e; }
        .tag-resuelto { background: #d1fae5; color: #065f46; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .btn-cancel { background: #e5e7eb; padding: 10px 20px; border-radius: 6px; cursor: pointer; border: none; }
        .btn-save { background: var(--success); color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; }

        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <div class="login-logo">
            <h1>ADIFINCAS</h1>
            <p>Acceso Restringido al Sistema</p>
        </div>
        <form id="loginForm">
            <input type="email" id="loginEmail" class="login-input" placeholder="Correo electr√≥nico..." required>
            <input type="password" id="loginPass" class="login-input" placeholder="Contrase√±a..." required>
            <button type="submit" class="btn-login">Entrar al Sistema</button>
            <div id="loginError" class="error-msg">Credenciales incorrectas</div>
        </form>
    </div>
</div>

<div class="container" id="appContainer">
    <header>
        <div class="logo">
            <h1>ADIFINCAS <span style="font-size:0.5em; color:#9ca3af; font-weight:400">| v3.0</span></h1>
        </div>
        <div class="user-info">
            <div class="user-badge">üë§ <span id="displayUser">Invitado</span></div>
            <button class="btn-db" onclick="scrollToTable()">
                üóÑÔ∏è Base de Datos
            </button>
            <button class="btn-db" onclick="exportToExcel()" style="background: #1D6F42;" title="Descargar Excel">
                üì• Excel
            </button>
        </div>
    </header>

    <div class="main-grid">
        <section class="form-section">
            <h2 style="margin-top:0; color:var(--primary)">üìû Nueva Llamada</h2>
            <form id="callForm">
                <div class="form-group">
                    <label>Cliente / Raz√≥n Social</label>
                    <input type="text" id="callerName" placeholder="Escribe para buscar..." autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="text" id="phoneNumber" placeholder="Ej: 600..." autocomplete="off" required>
                </div>

                <div id="matchAlert">
                    <h4>‚ö†Ô∏è Historial Detectado: <span id="matchCount">0</span></h4>
                    <div id="matchList"></div>
                </div>

                <div class="form-group">
                    <label>Estado</label>
                    <select id="status">
                        <option value="Pendiente">üî¥ Pendiente</option>
                        <option value="En Curso">üü† En Curso</option>
                        <option value="Resuelto">üü¢ Resuelto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Motivo</label>
                    <textarea id="reason" placeholder="Motivo de la llamada..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Acci√≥n / Nota</label>
                    <textarea id="action" placeholder="Nota inicial..." style="min-height: 60px;"></textarea>
                </div>
                <button type="submit" class="btn-primary" id="submitBtn">Guardar Llamada</button>
            </form>
        </section>

        <section class="data-section" id="databaseSection">
            <div class="search-bar">
                <input type="text" id="mainSearch" placeholder="üîç Buscar en toda la base de datos..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
            </div>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Tel√©fono</th>
                            <th>Motivo / Acci√≥n</th>
                            <th>Estado</th>
                            <th>Agente</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="6" style="text-align:center; padding: 20px;">Cargando base de datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>
</div>

<div class="modal-overlay" id="editModal">
    <div class="modal">
        <h2 style="margin-top:0; color:var(--primary)">‚úèÔ∏è Editar Registro</h2>
        <input type="hidden" id="editId">
        
        <div class="form-group">
            <label>Estado Actual</label>
            <select id="editStatus">
                <option value="Pendiente">Pendiente</option>
                <option value="En Curso">En Curso</option>
                <option value="Resuelto">Resuelto</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Motivo Original</label>
            <textarea id="editReason" rows="3"></textarea>
        </div>

        <div class="form-group">
            <label>A√±adir Nueva Nota / Acci√≥n</label>
            <textarea id="editAction" rows="4" placeholder="A√±adir seguimiento..."></textarea>
        </div>

        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
            <button class="btn-save" onclick="saveEdit()">Guardar Cambios</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // 1. GESTI√ìN DE USUARIOS
    const USERS = {
        "inavarro@adifincas.es": { pass: "inavarro", name: "Navarro" },
        "atencion1@adifincas.es": { pass: "atencion1", name: "Atencion1" },
        "jmgallego@adifincas.es": { pass: "jmgallego", name: "Jmgallego" }
    };
    
    let CURRENT_USER_NAME = "Invitado";

    // L√≥gica de Login
    document.getElementById("loginForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value.toLowerCase().trim();
        const pass = document.getElementById("loginPass").value.trim();
        const errorMsg = document.getElementById("loginError");

        if (USERS[email] && USERS[email].pass === pass) {
            // Login correcto
            CURRENT_USER_NAME = USERS[email].name;
            document.getElementById("displayUser").innerText = CURRENT_USER_NAME;
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("appContainer").style.display = "block";
            // Iniciar Firebase solo tras login
            initFirebase();
        } else {
            errorMsg.style.display = "block";
        }
    });

    // 2. FIREBASE & APP
    const firebaseConfig = {
        apiKey: "AIzaSyBqgvaRhWg7rm5FeKchH08H5zQr5d6fXDY",
        authDomain: "adifincas-db.firebaseapp.com",
        databaseURL: "https://adifincas-db-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "adifincas-db",
        storageBucket: "adifincas-db.firebasestorage.app",
        messagingSenderId: "987315627646",
        appId: "1:987315627646:web:66049a3005281035e7da2f",
        measurementId: "G-G1Y3L2LS3D"
    };

    let db, callsRef, allCalls = [];

    function initFirebase() {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        callsRef = ref(db, 'registros_adifincas');

        // Escuchar datos
        onValue(callsRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) {
                allCalls = [];
                renderTable([]);
                return;
            }
            allCalls = Object.entries(data).map(([id, val]) => ({ id, ...val })).reverse();
            renderTable(allCalls);
            checkMatches();
        });
    }

    // 3. FUNCIONES DE INTERFAZ
    window.scrollToTable = function() {
        document.getElementById("databaseSection").scrollIntoView({behavior: "smooth"});
    };

    window.exportToExcel = function() {
        let csv = "Fecha,Hora,Agente,Cliente,Telefono,Estado,Motivo,Accion\n";
        allCalls.forEach(c => {
            csv += `"${c.date}","${c.time}","${c.user}","${c.name}","${c.phone}","${c.status}","${c.reason.replace(/"/g, '""')}","${(c.action||'').replace(/"/g, '""')}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "Base_Datos_Adifincas.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    // Renderizar Tabla
    function renderTable(data) {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        data.forEach(call => {
            const tr = document.createElement("tr");
            const cleanStatus = call.status ? call.status.toLowerCase().replace(" ", "-") : "pendiente";
            tr.innerHTML = `
                <td style="color:#666; font-size:0.85em">${call.date}<br>${call.time}</td>
                <td><strong>${call.name}</strong></td>
                <td><a href="tel:${call.phone}" style="color:var(--primary); text-decoration:none">${call.phone}</a></td>
                <td>
                    <div>${call.reason}</div>
                    ${call.action ? `<small style="color:#555; display:block; margin-top:4px; border-top:1px dashed #eee; padding-top:2px">üëâ ${call.action}</small>` : ''}
                </td>
                <td><span class="tag tag-${cleanStatus}">${call.status}</span></td>
                <td style="font-size:0.85em; color:#666">${call.user}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 4. DETECTOR DE COINCIDENCIAS
    const nameInput = document.getElementById("callerName");
    const phoneInput = document.getElementById("phoneNumber");

    function checkMatches() {
        const nameVal = nameInput.value.toLowerCase();
        const phoneVal = phoneInput.value.replace(/\s/g, '');
        if (nameVal.length < 3 && phoneVal.length < 4) {
            document.getElementById("matchAlert").style.display = "none";
            return;
        }
        const matches = allCalls.filter(call => {
            const cName = call.name.toLowerCase();
            const cPhone = call.phone.replace(/\s/g, '');
            return (nameVal.length >= 3 && cName.includes(nameVal)) || 
                   (phoneVal.length >= 4 && cPhone.includes(phoneVal));
        });
        renderMatches(matches);
    }

    function renderMatches(matches) {
        const alertBox = document.getElementById("matchAlert");
        const list = document.getElementById("matchList");
        if (matches.length === 0) { alertBox.style.display = "none"; return; }
        
        alertBox.style.display = "block";
        document.getElementById("matchCount").innerText = matches.length;
        list.innerHTML = "";
        
        matches.slice(0, 3).forEach(m => {
            const item = document.createElement("div");
            item.className = "mini-history-item";
            item.innerHTML = `
                <div class="mini-history-header">
                    <span>üìÖ ${m.date} (${m.user})</span>
                    <button class="btn-mini-edit" title="Editar">‚úèÔ∏è</button>
                </div>
                <div style="font-weight:bold; color:var(--primary); font-size:0.8em">${m.status}</div>
                <div>${m.reason}</div>
                <div style="font-style:italic; color:#666; font-size:0.9em; margin-top:3px">${m.action || ''}</div>
            `;
            item.querySelector(".btn-mini-edit").addEventListener("click", (e) => { e.preventDefault(); openEditModal(m); });
            list.appendChild(item);
        });
    }

    nameInput.addEventListener("input", checkMatches);
    phoneInput.addEventListener("input", checkMatches);

    // 5. GUARDAR Y EDITAR
    document.getElementById("callForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const btn = document.getElementById("submitBtn");
        btn.disabled = true; btn.innerText = "Guardando...";
        
        const now = new Date();
        push(callsRef, {
            user: CURRENT_USER_NAME, // Usa el usuario logueado
            name: document.getElementById("callerName").value,
            phone: document.getElementById("phoneNumber").value,
            status: document.getElementById("status").value,
            reason: document.getElementById("reason").value,
            action: document.getElementById("action").value,
            date: now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
            time: now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
        }).then(() => {
            document.getElementById("callForm").reset();
            document.getElementById("matchAlert").style.display = "none";
            btn.disabled = false; btn.innerText = "Guardar Llamada";
        });
    });

    window.openEditModal = function(call) {
        document.getElementById("editId").value = call.id;
        document.getElementById("editStatus").value = call.status;
        document.getElementById("editReason").value = call.reason;
        document.getElementById("editAction").value = call.action || "";
        document.getElementById("editModal").style.display = "flex";
    };
    window.closeModal = function() { document.getElementById("editModal").style.display = "none"; };
    
    window.saveEdit = function() {
        const id = document.getElementById("editId").value;
        update(ref(db, 'registros_adifincas/' + id), {
            status: document.getElementById("editStatus").value,
            reason: document.getElementById("editReason").value,
            action: document.getElementById("editAction").value
        }).then(() => { closeModal(); });
    };

    // Buscador general
    document.getElementById("mainSearch").addEventListener("keyup", (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allCalls.filter(c => JSON.stringify(c).toLowerCase().includes(term));
        renderTable(filtered);
    });

</script>
</body>
</html>
